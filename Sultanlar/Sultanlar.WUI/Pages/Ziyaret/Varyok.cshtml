@page
@model VaryokModel
@{
    ViewData["Title"] = "Var/Yok Liste";
}

@section head {
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs/dt-1.10.18/r-2.2.2/datatables.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretty-checkbox@3.0/dist/pretty-checkbox.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />

    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/v/bs/dt-1.10.18/r-2.2.2/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.tr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="~/js/lazyloadcontent.js"></script>

    <script>
        var sepet;
        var paramsmref;
        var paramgmref;
        var parammtip;
        var ziyaretid;
        var incele;
        var table;
        var dahaoncekaydedilmis;

        function getListe() {
            $("#divKaydetSil").css("display", "block");
            table = $('#dtTable').DataTable({
                "aaData": sepet.detays,
                "aoColumns": [
                    {
                        "mDataProp": null, "class": "bgwhite keyTd hidewhenmobile", render: function (data, type, row) {
                            if (data.odemE_GUN > 0)
                                return '<div class="imgKucRes"><img class="urunResim lazyload" rel="' + apiurl + 'resim/getT/' + data.itemref + '" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="' + apiurl + 'resim/getTO/' + data.itemref + '" /></div>';
                            else
                                return '<div style="width:100px; height:100px"><img class="urunResim" data-src="' + apiurl + 'resim/getTO/' + data.itemref + '" /></div>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": "malzeme", "class": "keyTd", render: function (data, type, row) {
                            return '<span class="sinirli" data-toggle="tooltip" title="' + data.barkod + '">' + data.itemref + '</span>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd hidewhenmobile" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            console.log(data.itemref.toString()[0]);
                            if (incele && ziyaretid != 0)
                                return '<span class="sinirli">' + (data.fiyatvy.isaret && data.fiyatvy.sonalim && data.fiyatvy.sonalim.indexOf("0001-01-01") == -1 && data.fiyatvy.sonalim.indexOf("2000-01-01") == -1 ? data.fiyatvy.sonalim.substring(0, 10) : '-') + '</span>';
                            else
                                return (data.itemref.toString()[0] != "3" ? '<span class="sinirli lazyloadc llctarih" data-src="' + apiurl + 'satisraporu/sonalimdetay/' + paramgmref + '/' + + parammtip + '/' + paramsmref + '/' + data.itemref + '"><i>yükleniyor...</i></span>' : '');
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": "malzeme", "class": "keyTd hide", render: function (data, type, row) {
                            return '<span class="sinirli">' + data.ozelacik + '</span>';
                        }
                    },
                    {
                        "mDataProp": "malacik", "class": "valueTd", render: function (data, type, row) {
                            return '<span class="sinirli malacik">' + data + '</span>';
                        }
                    },
                    {
                        "mDataProp": "malzeme", "class": "keyTd hidewhenmobile", render: function (data, type, row) {
                            return '<span class="sinirli">' + data.koli + '</span>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": "fiyatvy", "class": "keyTd hide", render: function (data, type, row) {
                            return '<span class="sinirli">' + data.isaret + '</span>';
                        }
                    },
                    {
                        "mDataProp": "fiyatvy", "class": "keyTd hide", render: function (data, type, row) {
                            return '<span class="sinirli">' + data.varyok + '</span>';
                        }
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<div class="pretty p-default p-curve prettyMargin2 p-toggle">' +
                                '<input type="checkbox" onchange="checkDisEn(this)" ' + (incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '"' + (data.fiyatvy.isaret == true ? 'checked="checked"' : '') + ' />' +
                                '<div class="state p-success p-on"><label></label></div><div class="state p-danger p-off"><label></label></div></div>';
                        },
                        "name": "isaret",
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<div class="pretty p-default p-curve prettyMargin2">' +
                                '<input type="checkbox" class="checkler" onchange="checkyap(this,0)" ' + (data.fiyatvy.isaret == false || incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '" ' + (data.fiyatvy.varyok == true ? 'checked="checked"' : '') + ' />' +
                                '<div class="state p-primary"><label></label></div></div>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<div class="pretty p-default p-curve prettyMargin2">' +
                                '<input type="checkbox" class="checkler" onchange="checkyap(this,1)" ' + (data.fiyatvy.isaret == false || incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '" ' + (data.fiyatvy.depo == true ? 'checked="checked"' : '') + ' />' +
                                '<div class="state p-primary"><label></label></div></div>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<div class="pretty p-default p-curve prettyMargin2">' +
                                '<input type="checkbox" class="checkler" onchange="checkyap(this,2)" ' + (data.fiyatvy.isaret == false || incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '" ' + (data.fiyatvy.raf == true ? 'checked="checked"' : '') + ' />' +
                                '<div class="state p-primary"><label></label></div></div>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<input type="number" class="checkler inputSecim" onchange="checkyap(this,3)" ' + (data.fiyatvy.isaret == false || incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '" ' + 'value="' + data.fiyatvy.raffiyat + '"' + ' />';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<div class="pretty p-default p-curve prettyMargin2">' +
                                '<input type="checkbox" class="checkler" onchange="checkyap(this,4)" ' + (data.fiyatvy.isaret == false || incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '" ' + (data.fiyatvy.skt == true ? 'checked="checked"' : '') + ' />' +
                                '<div class="state p-primary"><label></label></div></div>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": null, "class": "keyTd" + (ziyaretid == 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<input type="number" class="checkler inputSecim" onchange="checkyap(this,5)" ' + (data.fiyatvy.isaret == false || incele ? 'disabled' : '') + ' accesskey="' + data.itemref + '" ' + 'value="' + data.fiyatvy.siparis + '"' + ' />';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": "net", "class": "keyTd hidewhenmobile" + (ziyaretid != 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<span class="sinirli">' + data.toFixed(2) + '</span>';
                        },
                        "width": "1%"
                    },
                    {
                        "mDataProp": "netkdv", "class": "keyTd hidewhenmobile" + (ziyaretid != 0 ? " hide" : ""), render: function (data, type, row) {
                            return '<span class="sinirli">' + data.toFixed(2) + '</span>';
                        },
                        "width": "1%"
                    }
                ],
                "scrollX": true,
                "language": defaultDtLang,
                "paging": true,
                "info": false,
                "searching": true,
                "deferRender": true,
                "order": [[3, "asc"]],
                "initComplete": function (settings, json) {
                    $('.dataTables_filter input').keyup(function () {
                        $(this).val($(this).val().toLocaleUpperCase());
                    });
                    var json1 = settings.oInit.aaData;

                    if (parseInt(sepet.tip) == 7) {
                        var datatablethis = $(this);
                        $.ajax(
                            {
                                beforeSend: function (xhr) { xhrTicket(xhr); },
                                url: apiurl + 'fiyat/GetSmrefad/' + paramsmref,
                                success: function (data, textStatus, response) {
                                    if (data.length > 0) {
                                        var newjson = [];
                                        $.each(json1, function (i, item) {
                                            $.each(data, function (i, item2) {
                                                if (item.itemref == item2.itemref) {
                                                    newjson.push(item);
                                                }
                                            });
                                        });
                                        if (newjson.length > 0) {
                                            datatablethis.dataTable().fnClearTable();
                                            datatablethis.dataTable().fnAddData(newjson);
                                        }
                                        else {
                                            datatablethis.dataTable().fnClearTable();
                                            datatablethis.dataTable().fnAddData(data);
                                        }
                                    }

                                }
                            }
                        );
                    }
                },
                "rowCallback": function (row, data, index) {

                },
                "fnDrawCallback": function (oSettings) {
                    qtip();
                    $('[data-toggle="tooltip"]').tooltip();
                    $('[data-toggle="tooltip"]').css("cursor", "pointer");
                    if (ziyaretid != 0) {
                        $(".dt-buttons").css("display", "none");
                    }
                },
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'pdfHtml5',
                        exportOptions: {
                            columns: [0, 1, 4, 5, 15, 16]
                        },
                        filename: function () {
                            return 'Sultanlar Fiyat Listesi-' + getParameterByName('ftip');
                        },
                        customize: function (doc) {
                            doc.content[0].text = "Sultanlar";
                            /*var arr = $('.urunResim').map(function () {
                                return $(this).attr("data-src");
                            }).get();*/

                            for (var i = 1; i < doc.content[1].table.body.length; i++) {
                                var img = getBase64Image(apiurl + "resim/getTObase64/" + doc.content[1].table.body[i][1].text);
                                doc.content[1].table.body[i][0] = { image: "data:image/png;base64," + img };
                            }
                            doc.content.splice(1, 0, {
                                margin: [0, 0, 0, 12],
                                alignment: 'center',
                                text: 'Fiyat Listesi: ' + getParameterByName('ftip')
                            });
                        }
                    },
                    {
                        extend: 'print',
                        exportOptions: {
                            columns: [1, 4, 5, 15, 16]
                        }
                    },
                    {
                        extend: 'excel',
                        exportOptions: {
                            columns: [1, 4, 5, 15, 16],
                            format: {
                                body: function (data, row, column, node) {
                                    data = $('<p>' + data + '</p>').text();
                                    return $.isNumeric(data.replace(',', '.')) ? data.replace(',', '.') : data;
                                }
                            }
                        },
                        filename: function () {
                            return 'Sultanlar Fiyat Listesi-' + getParameterByName('ftip');
                        },
                        customize: function (xlsx) {
                            var sheet = xlsx.xl.worksheets['sheet1.xml'];
                            $('c[r=A1] t', sheet).text('Fiyat Listesi: ' + getParameterByName('ftip'));
                        }
                    }
                ]
            });
        }

        function fiyattip500birlikte() {
            $.ajax(
                {
                    xhr: function () { return xhrDownloadUpload(); },
                    beforeSend: function (xhr) { xhrTicket(xhr); },
                    url: apiurl + "fiyat/getfiyattipler500birlikte",
                    async: false,
                    success: function (data2, textStatus, response) {

                        $.each(data2, function (i, item2) {
                            $("#selectFiyatTipler").append(
                                $("<option></option>")
                                    .text(item2.aciklama)
                                    .val(item2.nosu)
                            );
                        });
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                });
        }

        function getFiyatlar() {
            $.ajax(
                {
                    beforeSend: function (xhr) { xhrTicket(xhr); },
                    url: apiurl + 'Cari/GetCari/' + parammtip + '/' + paramsmref,
                    success: function (data1, textStatus, response) {

                        if ((parammtip == 1 || parammtip == 2 || parammtip == 4 || parammtip == 5) && data1.fiyatTip500smref != 0) {
                            $("#selectFiyatTipler").append(
                                $("<option></option>")
                                    .text(data1.fiyatTip500smrefack)
                                    .val(data1.fiyatTip500smref)
                            );
                            fiyattip500birlikte();
                        } else if ((parammtip == 1 || parammtip == 2 || parammtip == 4 || parammtip == 5) && data1.fiyatTip500 != 0) {
                            $("#selectFiyatTipler").append(
                                $("<option></option>")
                                    .text(data1.fiyatTip500ack)
                                    .val(data1.fiyatTip500)
                            );
                            fiyattip500birlikte();
                        }
                        else {
                            $.ajax(
                                {
                                    xhr: function () { return xhrDownloadUpload(); },
                                    beforeSend: function (xhr) { xhrTicket(xhr); },
                                    url: apiurl + "uyeyetki/" + localStorage["musteri"],
                                    success: function (data, textStatus, response) {
                                        checkAuth(response);

                                        var rootData = Object.keys(data.fiyatTipleri).length == 0 ? data.grupFiyatTipleri : data.fiyatTipleri;

                                        $.each(rootData, function (index, item) {
                                            /*if (parammtip == 1 || parammtip == 2 || parammtip == 4 || parammtip == 5) {
                                                if (data1.fiyatTip500smref == 0 && data1.fiyatTip500 == 0) {
                                                    $("#selectFiyatTipler").append(
                                                        $("<option></option>")
                                                            .text(item.fiyatTipi.aciklama)
                                                            .val(item.sintFiyatTipiID)
                                                    );
                                                }
                                                else {
                                                    if (item.sintFiyatTipiID != 0 && data1.fiyatTip500 == item.sintFiyatTipiID) {
                                                        $("#selectFiyatTipler").append(
                                                            $("<option></option>")
                                                                .text(item.fiyatTipi.aciklama)
                                                                .val(item.sintFiyatTipiID)
                                                        );
                                                    }
                                                }
                                            }
                                            else {
                                                $("#selectFiyatTipler").append(
                                                    $("<option></option>")
                                                        .text(item.fiyatTipi.aciklama)
                                                        .val(item.sintFiyatTipiID)
                                                );
                                            }*/

                                            $("#selectFiyatTipler").append(
                                                $("<option></option>")
                                                    .text(item.fiyatTipi.aciklama)
                                                    .val(item.sintFiyatTipiID)
                                            );
                                        });
                                    },
                                    error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                                }
                            );
                        }
                    }
                }
            );
        }

        function checkDisEn(ctrl) {
            if (!ctrl.checked) {
                $(ctrl).closest("tr").find(".checkler").prop("disabled", true);
                //$(ctrl).closest("tr").find(".checkler").prop("checked", false);
            }
            else {
                $(ctrl).closest("tr").find(".checkler").prop("disabled", false);
            }

            $.each(sepet.detays, function (index, item) {
                if (item.itemref == $(ctrl).prop("accessKey")) {
                    item.fiyatvy.isaret = ctrl.checked;
                }
            });
            window.localStorage['sepetV'] = JSON.stringify(sepet);
        }

        function checkyap(ctrl, tur) {
            $.each(sepet.detays, function (index, item) {
                if (item.itemref == $(ctrl).prop("accessKey")) {
                    if (tur == 0)
                        item.fiyatvy.varyok = ctrl.checked;
                    if (tur == 1)
                        item.fiyatvy.depo = ctrl.checked;
                    if (tur == 2)
                        item.fiyatvy.raf = ctrl.checked;
                    if (tur == 3)
                        item.fiyatvy.raffiyat = ctrl.value;
                    if (tur == 4)
                        item.fiyatvy.skt = ctrl.checked;
                    if (tur == 5)
                        item.fiyatvy.siparis = ctrl.value;
                }
            });
            window.localStorage['sepetV'] = JSON.stringify(sepet);
        }

        function kaydet() {
            if (sepet) {

                var sentData = { barkod: sepet.barkod, tip: sepet.tip, musteri: window.localStorage["uyeid"], sonalim: document.getElementById("sonAlim").innerHTML, detays: [] };

                for (var i = 0; i < sepet.detays.length; i++) {
                    //if (sepet.detays[i].fiyatvy.isaret == true) {
                    sentData.detays.push(
                        {
                            itemref: sepet.detays[i].itemref,
                            isaret: sepet.detays[i].fiyatvy.isaret,
                            varyok: sepet.detays[i].fiyatvy.varyok,
                            depo: sepet.detays[i].fiyatvy.depo,
                            raf: sepet.detays[i].fiyatvy.raf,
                            raffiyat: sepet.detays[i].fiyatvy.raffiyat,
                            skt: sepet.detays[i].fiyatvy.skt,
                            siparis: sepet.detays[i].fiyatvy.siparis
                        });
                    //}
                }

                $.ajax(
                    {
                        xhr: function () { return xhrDownloadUpload(); },
                        beforeSend: function (xhr) { xhrTicket(xhr); },
                        type: 'POST',
                        //timeout: 15000,
                        url: apiurl + "ziyaret/varyokekle",
                        data: JSON.stringify(sentData),
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json',
                        success: function (data, textStatus, response) {
                            checkAuth(response);
                            window.localStorage.removeItem("sepetV");
                            if (data == '')
                                alert('Liste gönderildi.');
                            else
                                alert('Liste kaydedilemedi: ' + data);
                            window.location.href = 'Ziyaret';
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            if (XMLHttpRequest.readyState == 4) {
                                alert('hata:' + JSON.stringify(sentData)); window.location.href = 'Ziyaret';
                            }
                            else if (XMLHttpRequest.readyState == 0) {
                                alert('Bağlantı hatası.');
                            }
                            else {
                                alert('hata: ' + JSON.stringify(sentData)); window.location.href = 'Ziyaret';
                            }

                            hataekle('ziyaretvaryok ' + XMLHttpRequest.readyState, btoa(JSON.stringify(sentData)));
                        }
                    }
                );

            }
        }

        function sil() {
            $.ajax(
                {
                    xhr: function () { return xhrDownloadUpload(); },
                    beforeSend: function (xhr) { xhrTicket(xhr); },
                    url: apiurl + "ziyaret/varyoksil/" + ziyaretid,
                    success: function (data, textStatus, response) {
                        checkAuth(response);

                        window.localStorage.removeItem("sepetV");
                        window.location.href = 'Ziyaret';
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                }
            );
        }

        function geri() {
            window.history.back();
        }

        function qtip() {
            $('.urunResim').each(function () {
                $(this).qtip({
                    content: '<img src="' + $(this).attr('rel') + '" class="urunResimQtip" />',
                    position: { at: 'top right' }
                });
            });
            lazyload();
            lazyloadc();
        }

        $(document).ready(function () {
            paramgmref = getParameterByName('gmref');
            paramsmref = getParameterByName('smref');
            parammtip = getParameterByName('mtip');
            ziyaretid = getParameterByName('ziyaretid');
            incele = getParameterByName('incele') ? true : false;

            getCari(parammtip, paramsmref, getCariSube, "ziyMus");

            if (incele) {
                $("#inputKaydet").css("display", "none");
                $("#inputSil").css("display", "none");
                $("#selectFiyatTipler").css("display", "none");

                $.ajax(
                    {
                        xhr: function () { return xhrDownloadUpload(); },
                        beforeSend: function (xhr) { xhrTicket(xhr); },
                        url: apiurl + "ziyaret/varyokgetir/" + ziyaretid,
                        success: function (data, textStatus, response) {
                            checkAuth(response);

                            document.getElementById("tarih").innerHTML = data.tarih.replace("T", " ");
                            document.getElementById("sonAlim").innerHTML = data.sonalim.substring(0, 10);
                            sepet = { barkod: data.barkod, tip: data.fiyaT_TIP, detays: [] };

                            $.ajax(
                                {
                                    xhr: function () { return xhrDownloadUpload(); },
                                    beforeSend: function (xhr) { xhrTicket(xhr); },
                                    url: apiurl + "fiyat/getbytip/" + data.fiyaT_TIP + "/" + paramgmref + "/" + parammtip + "/" + paramsmref, //getbytipakt
                                    success: function (data1, textStatus, response) {
                                        checkAuth(response);

                                        $.ajax(
                                            {
                                                xhr: function () { return xhrDownloadUpload(); },
                                                beforeSend: function (xhr) { xhrTicket(xhr); },
                                                url: apiurl + "fiyat/getharic",
                                                success: function (data2, textStatus, response) {
                                                    checkAuth(response);

                                                    for (var i = 0; i < data2.length; i++) {
                                                        data1.push(data2[i]);
                                                    }

                                                    dataS = [];
                                                    for (var i = 0; i < data1.length; i++) {
                                                        for (var j = 0; j < data.detays.length; j++) {
                                                            if (data.detays[j].itemref == data1[i].itemref) {
                                                                data1[i].fiyatvy.isaret = data.detays[j].isaret;
                                                                data1[i].fiyatvy.varyok = data.detays[j].varyok;
                                                                data1[i].fiyatvy.depo = data.detays[j].depo;
                                                                data1[i].fiyatvy.raf = data.detays[j].raf;
                                                                data1[i].fiyatvy.raffiyat = data.detays[j].raF_FIYAT;
                                                                data1[i].fiyatvy.skt = data.detays[j].skt;
                                                                data1[i].fiyatvy.siparis = data.detays[j].siparis;
                                                                data1[i].fiyatvy.sonalim = data.detays[j].sonalim;

                                                                dataS.push(data1[i]);
                                                            }
                                                        }
                                                        /*if (data1[i].fiyatvy.isaret == true) {
                                                            dataS.push(data1[i]);
                                                        }*/
                                                    }

                                                    sepet.detays = dataS;
                                                    $("#dtTable").css("display", "table");
                                                    getListe();

                                                    if (data.pkID != 0) {
                                                        $.ajax(
                                                            {
                                                                url: apiurl + "ziyaret/varyoklogekle/" + data.pkID + "/" + localStorage["musteri"] + "/" + localStorage["slsref"],
                                                                success: function (data, textStatus, response) {

                                                                },
                                                                error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                                                            }
                                                        );
                                                    }
                                                },
                                                error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                                            }
                                        );
                                    },
                                    error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                                }
                            );
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                    }
                );
            }
            else {
                $("#divKontrol").css("display", "none");
                $("#divVy").css("display", "none");

                if (ziyaretid == 0) {
                    $("#inputKaydet").css("display", "none");
                    $("#inputSil").css("display", "none");
                    $("#selectFiyatTipler").css("display", "none");
                    incele = true;
                    sepet = { barkod: '', tip: getParameterByName('ftip'), detays: [] };

                    $.ajax(
                        {
                            xhr: function () { return xhrDownloadUpload(); },
                            beforeSend: function (xhr) { xhrTicket(xhr); },
                            url: apiurl + "fiyat/getbytip/" + getParameterByName('ftip') + "/" + paramgmref + "/" + parammtip + "/" + paramsmref, //getbytipakt
                            success: function (data1, textStatus, response) {
                                checkAuth(response);

                                sepet.detays = data1;
                                $("#dtTable").css("display", "table");
                                getListe();
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                        }
                    );
                }
                else {

                    getSonFaturaTarih(paramgmref, parammtip, paramsmref, "sonAlim");

                    $.ajax(
                        {
                            xhr: function () { return xhrDownloadUpload(); },
                            beforeSend: function (xhr) { xhrTicket(xhr); },
                            url: apiurl + "ziyaret/varyokgetir/" + ziyaretid,
                            success: function (data, textStatus, response) {
                                checkAuth(response);

                                sepet = { barkod: data.barkod, tip: data.fiyaT_TIP, detays: [] };

                                if (window.localStorage['sepetV'] == undefined && data.pkID > 0) {
                                    dahaoncekaydedilmis = true;
                                    alert("Daha önceden liste kaydedilmiş");

                                    $.ajax(
                                        {
                                            xhr: function () { return xhrDownloadUpload(); },
                                            beforeSend: function (xhr) { xhrTicket(xhr); },
                                            url: apiurl + "fiyat/getbytip/" + data.fiyaT_TIP + "/" + paramgmref + "/" + parammtip + "/" + paramsmref, //getbytipakt
                                            success: function (data1, textStatus, response) {
                                                checkAuth(response);

                                                $.ajax(
                                                    {
                                                        xhr: function () { return xhrDownloadUpload(); },
                                                        beforeSend: function (xhr) { xhrTicket(xhr); },
                                                        url: apiurl + "fiyat/getharic",
                                                        success: function (data2, textStatus, response) {
                                                            checkAuth(response);

                                                            for (var i = 0; i < data2.length; i++) {
                                                                data1.push(data2[i]);
                                                            }

                                                            for (var i = 0; i < data1.length; i++) {
                                                                for (var j = 0; j < data.detays.length; j++) {
                                                                    if (data.detays[j].itemref == data1[i].itemref) {
                                                                        data1[i].fiyatvy.isaret = data.detays[j].isaret;
                                                                        data1[i].fiyatvy.varyok = data.detays[j].varyok ? data.detays[j].varyok : false;
                                                                        data1[i].fiyatvy.depo = data.detays[j].depo;
                                                                        data1[i].fiyatvy.raf = data.detays[j].raf;
                                                                        data1[i].fiyatvy.raffiyat = data.detays[j].raF_FIYAT;
                                                                        data1[i].fiyatvy.skt = data.detays[j].skt;
                                                                        data1[i].fiyatvy.siparis = data.detays[j].siparis;
                                                                        data1[i].fiyatvy.sonalim = data.detays[j].sonalim;
                                                                    }
                                                                }
                                                            }

                                                            sepet.detays = data1;
                                                            $("#selectFiyatTipler").css("display", "none");
                                                            $("#dtTable").css("display", "table");
                                                            window.localStorage['sepetV'] = JSON.stringify(sepet);
                                                            getListe();
                                                        }
                                                    });
                                            },
                                            error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                                        }
                                    );
                                }
                                else {
                                    if (window.localStorage['sepetV']) {
                                        $("#selectFiyatTipler").css("display", "none");
                                        $("#dtTable").css("display", "table");
                                        sepet = JSON.parse(window.localStorage['sepetV']);
                                        getListe();
                                    }
                                    else {
                                        getFiyatlar();
                                    }
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                        }
                    );

                    $('#selectFiyatTipler').on('change', function (e) {
                        $("#selectFiyatTipler").css("display", "none");
                        $("#dtTable").css("display", "table");

                        var fiyattip = this.value;
                        $.ajax(
                            {
                                xhr: function () { return xhrDownloadUpload(); },
                                beforeSend: function (xhr) { xhrTicket(xhr); },
                                url: apiurl + "fiyat/getbytip/" + fiyattip + "/" + paramgmref + "/" + parammtip + "/" + paramsmref, //getbytipakt
                                success: function (data, textStatus, response) {
                                    checkAuth(response);

                                    $.ajax(
                                        {
                                            xhr: function () { return xhrDownloadUpload(); },
                                            beforeSend: function (xhr) { xhrTicket(xhr); },
                                            url: apiurl + "fiyat/getharic",
                                            success: function (data1, textStatus, response) {
                                                checkAuth(response);

                                                for (var i = 0; i < data1.length; i++) {
                                                    data.push(data1[i]);
                                                }

                                                sepet = { barkod: ziyaretid, tip: fiyattip, detays: data };
                                                window.localStorage['sepetV'] = JSON.stringify(sepet);
                                                getListe();
                                            },
                                            error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                                        }
                                    );
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                            }
                        );
                    });

                }
            }

            $('input[type=radio]').change(function () {
                filtrele();
            });

            function filtrele() {
                var val;
                $("#divTur input").each(function (index, element) {
                    if ($(element).is(':checked')) {
                        val = $(element).val();
                    }
                });

                var val1;
                $("#divKontrol input").each(function (index, element) {
                    if ($(element).is(':checked')) {
                        val1 = $(element).val();
                    }
                });

                var val2;
                $("#divVy input").each(function (index, element) {
                    if ($(element).is(':checked')) {
                        val2 = $(element).val();
                    }
                });

                if (val1 != 0)
                    table.columns(6).search(val1 == 1 ? "true" : val1 == 2 ? "false" : val1.toString()).draw();
                else
                    table.columns(6).search('').draw();

                if (val2 != 0)
                    table.columns(7).search(val2 == 1 ? "true" : val2 == 2 ? "false" : val2.toString()).draw();
                else
                    table.columns(7).search('').draw();

                table.columns(3).search(val == 1 ? "" : val).draw();
            }

            $('#dtTable').on('draw.dt', function () {

            });
        });
    </script>
}

<h5 class="spanCiplak" id="ziyMus"></h5>
<h5 class="spanCiplak" id="tarih"></h5>
@*<input class="form-control inputCiplak" type="text" name="inputAciklama" id="inputAciklama" placeholder="Açıklama" autocomplete="off">*@
<select id="selectFiyatTipler" name="selectFiyatTipler" class="dropDown">
    <option value="1" selected="selected">Seçiniz</option>
</select>
<div id="divKaydetSil">
    <input id="inputKaydet" type="button" class="btn btn-info secimTus" value="Listeyi Gönder" onclick="kaydet()" />
    <input id="inputSil" type="button" class="btn btn-danger secimTus" value="Listeyi Sil" onclick="sil()" />
    <input id="inputGeri" type="button" class="btn btn-warning secimTus" value="Geri Dön" onclick="geri()" />
    <br />
    <br />
</div>
<div>Son alım tarihi: <span id="sonAlim">-</span></div>
<div class="centerVeMiddle">
    <div id="divTur" data-toggle="buttons">
        <label class="btn btn-primary active">
            <input type="radio" name="options" id="option0" value="1" checked> Tümü
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="option1" value="ARI"> Arı
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="option2" value="HAYAT"> Gıda
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="option3" value="TİBET"> Temizlik
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="option4" value="YEG"> YEG
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="option5" value="ÇAPA MEDİKAL"> Banduff
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="option6" value="DİĞER"> Rakip Ürünler
        </label>
    </div>
    <div id="divKontrol" data-toggle="buttons">
        <label class="btn btn-info active">
            <input type="radio" name="options1" id="option0" value="0" checked> Tümü
        </label>
        <label class="btn btn-info">
            <input type="radio" name="options1" id="option1" value="1"> Kontrol Edilmiş
        </label>
        <label class="btn btn-info">
            <input type="radio" name="options1" id="option2" value="2"> Kontrol Edilmemiş
        </label>
    </div>
    <div id="divVy" data-toggle="buttons">
        <label class="btn btn-success active">
            <input type="radio" name="options2" id="option0" value="0" checked> Tümü
        </label>
        <label class="btn btn-success">
            <input type="radio" name="options2" id="option1" value="1"> Var
        </label>
        <label class="btn btn-success">
            <input type="radio" name="options2" id="option2" value="2"> Yok
        </label>
    </div>
</div>
<table id="dtTable" class="table table-striped table-bordered" style="width:100%; display: none" data-page-length='25'>
    <thead>
        <tr>
            <th class="keyTd"><span class="">&nbsp;&nbsp;&nbsp;&nbsp;Resim&nbsp;&nbsp;&nbsp;&nbsp;</span></th>
            <th class="keyTd"><span class="">Kod</span></th>
            <th class="keyTd"><span class="">Son Alım</span></th>
            <th class="keyTd"><span class="">Blm</span></th>
            <th class="keyTd"><span class="">Malzeme</span></th>
            <th class="keyTd"><span class="">Koli</span></th>
            <th class="keyTd"><span class="">is</span></th>
            <th class="keyTd"><span class="">vy</span></th>
            <th class="keyTd"><span class="">Knt.</span></th>
            <th class="keyTd"><span class="">V/Y</span></th>
            <th class="keyTd"><span class="">Depo</span></th>
            <th class="keyTd"><span class="">Raf</span></th>
            <th class="keyTd"><span class="">Raf F.</span></th>
            <th class="keyTd"><span class="">Skt</span></th>
            <th class="keyTd"><span class="">Sip</span></th>
            <th class="keyTd"><span class="">Net</span></th>
            <th class="keyTd"><span class="">Net+Kdv</span></th>
        </tr>
    </thead>
</table>
