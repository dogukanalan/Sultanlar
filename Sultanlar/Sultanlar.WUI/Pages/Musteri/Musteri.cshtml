@page
@model MusteriModel
@{
    ViewData["Title"] = "Müşteri";
}

@section head {
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs/dt-1.10.18/r-2.2.2/datatables.min.css" />

    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/v/bs/dt-1.10.18/r-2.2.2/datatables.min.js"></script>

    <script>
        function MusteriGetir(gmref, slsref) {
            var table = $('#dtTable').on('xhr.dt', function (e, settings, json, xhr) {
                checkAuth(xhr);
            }).DataTable({
                "responsive": true,
                "destroy": true,
                "processing": true,
                "serverSide": true,
                ajax: {
                    dataSrc: "json",
                    xhr: function () { return xhrDownloadUpload(); },
                    beforeSend: function (xhr) { xhrTicket(xhr); },
                    type: 'POST',
                    url: apiurl + "cari/getsube1/" + gmref + '/' + slsref,
                    data: function (d) {
                        return JSON.stringify(d);
                    },
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                },
                "fnDrawCallback": function (oSettings) {
                    $('[data-toggle="tooltip"]').tooltip();
                    $('[data-toggle="tooltip"]').css("cursor", "pointer");
                },
                columns: [
                    {
                        "data": "smref", "class": "keyTd", render: function (data, type, row) {
                            return '<span class="sinirli">' + data + '</span>'
                        },
                        "width": "15%"
                    },
                    {
                        "data": null, "class": "valueTd", render: function (data, type, row) {
                            return '<span class="sinirli3" data-toggle="tooltip" title="' + data.sube + '">' + data.sube + '</span>'
                        },
                        "width": "40%"
                    },
                    {
                        "data": null, "class": "valueTd", render: function (data, type, row) {
                            return '<span>' + data.adres + '</span>'
                        },
                        "width": "30%"
                    },
                    {
                        "data": null, "class": "keyTd", render: function (data, type, row) {
                            return '<a href="javascript:showSubMenu(div' + data.smref + ')" class="btn btn-primary">İşlemler</a>' +
                                '<div class="subMenu" id="div' + data.smref + '">' +
                                (data.tip == 4 ? '<a href="../Anlasma/?smref=' + data.smref + '&tip=' + data.tip + '">Anlaşma</a>' : '') +
                                (data.tip == 4 ? '<a href="../Aktivite/?smref=' + data.smref + '&ftip=25&tip=' + data.tip + '&aktiviteid=0">Aktivite</a>' : '') +
                                (data.tip == 4 ? '<a href="../Hizmet/?smref=' + data.smref + '">Hizmet Bedeli</a>' : '') +
                                '<a href="../Ziyaret/?smref=' + data.smref + '&gmref=' + gmref + '&slsref=' + (window.localStorage["slsref"] != "0" ? window.localStorage["slsref"] : getParameterByName("slsref")) + '&tip=' + data.tip + '&konum=' + data.konumA.konum + '">Ziyaret</a>' +
                                (data.tip == 1 ? '<a href="../Siparis/?smref=' + data.smref + '">Sipariş</a>' : '') +
                                (data.tip == 1 ? '<a href="../Iade/?smref=' + data.smref + '">İade</a></div>' : '');
                        },
                        "width": "15%"
                    }
                ],
                "language": defaultDtLang,
                "paging": true,
                "ordering": true,
                "info": false,
                "searching": true,
                "deferRender": true,
                "order": [[0, "desc"]]
            });

            $("div.dataTables_filter input").unbind();
            $("div.dataTables_filter input").on('keyup change', delay(function () {
                table.search(this.value).draw();
            }, aramadelay));

            /*$.ajax(
                {
                    xhr: function () { return xhrDownloadUpload(); },
                    beforeSend: function (xhr) { xhrTicket(xhr); },
                    url: apiurl + "cari/getsube1/" + gmref + '/' + slsref,
                    success: function (data, textStatus, response) {
                        checkAuth(response);

                        document.getElementById("sipMus").innerHTML = data[0].musteri;

                        var htmlText = '<table id="dtTable" class="table table-striped table-bordered" style="width:100%" data-page-length="50"><thead><tr><th class="keyTd hidewhenmobile">Kod</th><th class="keyTd">Müşteri</th><th></th></tr></thead><tbody>';
                        $.each(data, function (i, item) {
                            if (data[i].smref != gmref || data[i].tip != 4) { // tp den bayi tekrar gelmesin
                                htmlText += '<tr>';
                                htmlText += '<td class="keyTd hidewhenmobile"><span class="sinirli">' + data[i].smref + '</span></td>';
                                htmlText += '<td class="valueTd"><span class="sinirli3" data-toggle="tooltip" title="' + data[i].musteri + '">' + data[i].sube + '</span></td>';
                                htmlText += '<td class="keyTd"><a href="javascript:showSubMenu(div' + data[i].smref + ')" class="btn btn-primary">İşlemler</a><div class="subMenu" id="div' + data[i].smref + '">' +
                                    (data[i].tip == 4 ? '<a href="../Anlasma/?smref=' + data[i].smref + '&tip=' + data[i].tip + '">Anlaşma</a>' : '') +
                                    (data[i].tip == 4 ? '<a href="../Aktivite/?smref=' + data[i].smref + '&ftip=25&tip=1&aktiviteid=0">Aktivite</a>' : '') +
                                    (data[i].tip == 4 ? '<a href="../Hizmet/?smref=' + data[i].smref + '">Hizmet Bedeli</a>' : '') +
                                    '<a href="../Ziyaret/?smref=' + data[i].smref + '&gmref=' + gmref + '&slsref=' + getParameterByName("slsref") + '&tip=' + data[i].tip + '&konum=' + data[i].konumA.konum + '">Ziyaret</a>' +
                                    (data[i].tip == 1 ? '<a href="../Siparis/?smref=' + data[i].smref + '">Sipariş</a>' : '') +
                                    (data[i].tip == 1 ? '<a href="../Iade/?smref=' + data[i].smref + '">İade</a></div>' : '');
                                htmlText += '</td></tr>';
                            }
                        });
                        divData.innerHTML = htmlText + '</table>';
                        initDt(1, true, true, true);

                        $('[data-toggle="tooltip"]').tooltip();
                        $('[data-toggle="tooltip"]').css("cursor", "pointer");
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) { console.log('hata'); }
                }
            );*/
        }

        $(document).ready(function () {
            MusteriGetir(getParameterByName("gmref"), getParameterByName("slsref"));

            window.onclick = function (event) {
                if (!event.target.matches('.dropbtn')) {
                    var dropdowns = document.getElementsByClassName("subMenu");
                    var i;
                    for (i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            };
        });
    </script>
}
<h5 class="spanCiplak" id="sipMus"></h5>
<table id="dtTable" class="table table-striped table-bordered" style="width:100%" data-page-length='20'>
    <thead>
        <tr>
            <th class="keyTd" data-priority="3"><span class="">Kod</span></th>
            <th class="keyTd" data-priority="1"><span class="">Müşteri</span></th>
            <th class="keyTd" data-priority="4"><span class="">Adres</span></th>
            <th class="keyTd" data-priority="2"></th>
        </tr>
    </thead>
</table>